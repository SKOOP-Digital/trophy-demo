<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saginaw Schools Trophy Room</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Three.js and GLTFLoader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --navy: #000080; /* Default, will be overridden */
            --gold: #FFD700; /* Default, will be overridden */
            --black: #000000;
            --white: #ffffff;
            --gray: #f5f5f5;
            --dark-gray: #333333;
            --light-gray: #f8f9fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-bg: rgba(0, 0, 0, 0.85);
            --transition-speed: 0.3s;
            --border-radius: 10px;
            --card-shadow: 0 4px 6px var(--shadow-color);
            --hover-transform: translateY(-5px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            min-height: 100vh;
            background: var(--light-gray);
            overflow-x: hidden;
            color: var(--dark-gray);
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            /* Use JS to set background based on context or keep default */
            background: var(--navy);
            color: var(--white);
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background-color var(--transition-speed) ease;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold); /* Use dynamic gold */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            transition: color var(--transition-speed) ease;
        }

        .main-content {
            margin-top: 80px; /* Adjust if header height changes */
            padding: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .navigation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .nav-card {
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.05);
            min-height: 200px; /* Ensure cards have a minimum height */
        }

        .nav-card:hover {
            transform: var(--hover-transform);
            box-shadow: 0 8px 12px var(--shadow-color);
        }

        .nav-card-content {
            padding: 1.5rem;
            color: var(--white);
            height: 100%; /* Take full height */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            min-height: 200px; /* Match parent */
        }

        .nav-card-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 20%, rgba(0, 0, 0, 0.8) 100%);
            z-index: 1;
        }

        .nav-card-content > * {
            position: relative;
            z-index: 2;
        }

        .nav-card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--gold); /* Dynamic gold */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .nav-card p {
            font-size: 0.9rem;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--dark-gray);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
            z-index: 10;
        }

        .close-modal:hover {
            background: var(--gray);
            transform: rotate(90deg);
        }

        .trophy-display {
            perspective: 1000px;
            margin: 2rem 0;
            width: 100%;
            height: 450px; /* Slightly smaller */
            position: relative;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: inset 0 0 15px var(--shadow-color);
        }

        .trophy-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #trophy-canvas { /* Ensure canvas fills container */
            display: block;
            width: 100%;
            height: 100%;
            outline: none;
        }

        .trophy-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 30px;
            z-index: 1;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .trophy-control-btn {
            /* Colors set dynamically */
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .trophy-control-btn:hover {
            /* Colors set dynamically */
            transform: translateY(-2px);
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Smaller cards */
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .player-card {
            background: var(--white);
            padding: 1rem; /* Smaller padding */
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--card-shadow);
            border: 2px solid transparent; /* Reserve space for border */
            text-align: center; /* Center content */
        }

        .player-card:hover {
             /* Use dynamic colors */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--shadow-color);
        }

        .footer {
            /* Position fixed is often annoying, make it static */
            background: var(--navy); /* Dynamic navy */
            color: var(--white);
            padding: 1rem;
            text-align: center;
            margin-top: 3rem; /* Add space above */
            box-shadow: 0 -2px 10px var(--shadow-color);
            transition: background-color var(--transition-speed) ease;
        }

        .breadcrumb {
            margin-bottom: 2rem;
            color: var(--dark-gray);
            padding: 0.5rem 1rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            display: inline-flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: center;
        }

        .breadcrumb span {
            margin: 0 0.5rem;
            /* Color set dynamically */
            font-weight: 500;
        }
         .breadcrumb a {
            color: var(--navy); /* Dynamic navy */
            text-decoration: none;
            cursor: pointer;
            transition: color var(--transition-speed) ease;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .loading-spinner {
            /* Display is controlled by JS */
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray);
            border-top: 5px solid var(--navy); /* Dynamic navy */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transition: border-top-color var(--transition-speed) ease;
        }

        .trophy-loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0; /* Cover parent */
            display: flex; /* Use flex for centering */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: rgba(248, 249, 250, 0.9); /* Light gray bg */
            padding: 1rem;
            z-index: 5; /* Above canvas, below controls */
        }
        .trophy-loading p {
            margin-top: 1rem;
            color: var(--dark-gray);
        }


        .trophy-error {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0; /* Cover parent */
            display: flex; /* Use flex for centering */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #dc3545; /* Bootstrap danger red */
            background: rgba(248, 249, 250, 0.95); /* Light gray bg */
            padding: 1rem;
            border-radius: var(--border-radius); /* Match parent */
            z-index: 5;
        }
         .trophy-error h3 { margin-bottom: 0.5rem; }
         .trophy-error p { margin-bottom: 0.5rem; font-size: 0.9rem;}
         .trophy-error small { color: #6c757d; /* Bootstrap secondary gray */}

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Smaller cards */
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: var(--light-gray);
            padding: 0.8rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: inset 0 1px 3px var(--shadow-color); /* Inset shadow */
            border: 1px solid #dee2e6; /* Light border */
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--dark-gray);
            margin-bottom: 0.3rem;
        }
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            /* Color set dynamically */
        }

        .team-photo {
            width: 100%;
            max-width: 600px; /* Limit max width */
            height: auto;
            border-radius: var(--border-radius);
            margin: 1.5rem auto; /* Center */
            display: block;
            box-shadow: var(--card-shadow);
        }

        .athlete-category {
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .athlete-category h3 {
            margin-bottom: 1rem;
             /* Color set dynamically */
            border-bottom: 3px solid var(--gold); /* Dynamic gold */
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .player-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin: 0 auto 1rem auto; /* Center */
            border: 4px solid var(--navy); /* Dynamic navy */
            background-color: var(--light-gray); /* Placeholder bg */
            display: block;
        }

        .centered-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .loading-container {
            display: flex; /* Changed to flex */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Use min-height */
            padding: 2rem;
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--dark-gray);
            font-size: 1.1rem;
        }

        .error-container {
            display: none; /* Hide by default */
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background-color: #f8d7da; /* Light red background */
            border: 1px solid #f5c6cb; /* Red border */
            border-radius: var(--border-radius);
        }
         .error-container h2 { margin-bottom: 0.5rem;}

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .navigation-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
                max-height: 95vh;
            }

            .header-content {
                /* Allow flex-direction column on smaller screens if needed */
                /* flex-direction: column; */
                /* text-align: center; */
                /* gap: 0.5rem; */
            }

             .logo { font-size: 1.2rem; }

            .trophy-display {
                height: 350px;
            }

            .team-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                 gap: 1rem;
            }
             .player-card { padding: 0.8rem; }
             .stats-container { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
             .player-photo { width: 80px; height: 80px; border-width: 3px;}
        }
         @media (max-width: 480px) {
             .main-content { padding: 1rem; }
             .breadcrumb { font-size: 0.9rem; }
             .nav-card h2 { font-size: 1.3rem;}
             .team-grid { grid-template-columns: 1fr 1fr; /* Force two columns */}
             .player-card h4 { font-size: 0.9rem; }
             .player-card p { font-size: 0.8rem; }
         }

    </style>
</head>
<body>
    <header class="header" id="pageHeader">
        <div class="header-content">
            <div class="logo" id="pageLogo">Saginaw Schools Trophy Room</div>
            <!-- Navigation could go here if needed -->
        </div>
    </header>

    <main class="main-content">
        <div class="breadcrumb" id="breadcrumbContainer">
            <!-- Breadcrumbs will be generated here -->
        </div>

        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner" id="loadingSpinner"></div>
            <p class="loading-text">Loading trophy data...</p>
        </div>

        <div class="error-container" id="errorContainer">
            <h2>Error Loading Data</h2>
            <p id="errorMessage">Could not retrieve information. Please ensure the Budibase API is reachable and CORS is configured correctly.</p>
            <button onclick="loadAllData()">Retry</button>
        </div>

        <div class="navigation-grid" id="navigationGrid" style="display: none;">
            <!-- Dynamic content goes here -->
        </div>
    </main>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="close-modal" aria-label="Close modal">×</button>
            <div class="modal-body">
                <!-- Modal content goes here -->
            </div>
        </div>
    </div>

    <footer class="footer" id="pageFooter">
        <p>© <span id="currentYear"></span> Saginaw Schools Trophy Room. All rights reserved.</p>
    </footer>

    <script>
        // API Configuration
        const API_CONFIG = {
            BASE_URL: 'https://budibase.skoop.digital/api/public/v1/queries',
            HEADERS: {
                'x-budibase-app-id': 'app_3ea495f0892c4311badfd934783afd94',
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'x-budibase-api-key': '69b1bc10c2d32ee607e44e4a30f7f5ea-b9dd09ff6c773a4628f737a0ab45f9e0304e6a8c85181a90f8ff74cc29c946528f373cc83f24ae20'
            },
            ENDPOINTS: {
                SCHOOLS: 'query_datasource_plus_56025c99333e46b8a073e70585159c4c_4a3b9f6c024c4381afcf9f4e83f85f7d',
                TEAMS: 'query_datasource_plus_56025c99333e46b8a073e70585159c4c_a47c1c9912c34d15b67e49ec62908fa0',
                INDIVIDUALS: 'query_datasource_plus_56025c99333e46b8a073e70585159c4c_f62962e3b6ff47e690977d49cd6d6165'
            }
        };

        // Application State
        let appState = {
            schools: [],
            teams: [],
            individuals: [],
            navigationHistory: [], // Stores { type: 'school'/'sport', name: 'School Name'/'Sport Name' }
            currentSchool: null,   // The currently selected school object
            currentSport: null,    // The currently selected sport name string
            currentTheme: {        // Store current colors
                primary: '#000080', // Default Navy
                secondary: '#FFD700',// Default Gold
                accent: '#757575'   // Default Gray
            },
            viewerInstance: null // Holds the Three.js viewer
        };

        // DOM Elements
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const navigationGrid = document.getElementById('navigationGrid');
        const breadcrumbContainer = document.getElementById('breadcrumbContainer');
        const detailModal = document.getElementById('detailModal');
        const modalBody = detailModal.querySelector('.modal-body');
        const pageHeader = document.getElementById('pageHeader');
        const pageLogo = document.getElementById('pageLogo');
        const pageFooter = document.getElementById('pageFooter');
        const loadingSpinner = document.getElementById('loadingSpinner');
        document.getElementById('currentYear').textContent = new Date().getFullYear();


        // --- Data Fetching ---

        // Generic fetch function assuming Budibase CORS is configured
        async function fetchData(endpoint) {
            const url = `${API_CONFIG.BASE_URL}/${endpoint}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: API_CONFIG.HEADERS,
                    body: JSON.stringify({}) // Budibase queries often need an empty JSON body
                });

                if (!response.ok) {
                    // Improved error message including status text
                    throw new Error(`HTTP error ${response.status} (${response.statusText}) fetching ${endpoint}`);
                }

                const result = await response.json();
                // Expecting data format like [{ data: [...] }]
                if (Array.isArray(result) && result.length > 0 && result[0].data) {
                    return result[0].data; // Return the actual data array
                } else {
                     console.warn(`Unexpected data format received from ${endpoint}:`, result);
                     return []; // Return empty array if format is wrong
                }
            } catch (error) {
                console.error(`Error fetching data from ${endpoint}:`, error);
                // Re-throw the error so Promise.all catches it
                throw error;
            }
        }

        // Load all data concurrently
        async function loadAllData() {
            showLoading();
            try {
                const [schoolsData, teamsData, individualsData] = await Promise.all([
                    fetchData(API_CONFIG.ENDPOINTS.SCHOOLS),
                    fetchData(API_CONFIG.ENDPOINTS.TEAMS),
                    fetchData(API_CONFIG.ENDPOINTS.INDIVIDUALS)
                ]);

                appState.schools = schoolsData;
                appState.teams = teamsData;
                appState.individuals = individualsData;

                console.log("Data loaded:", { schools: appState.schools, teams: appState.teams, individuals: appState.individuals });

                 if (appState.schools.length === 0) {
                    throw new Error("No school data loaded. Check API response or CORS configuration.");
                 }

                // Reset to home view after loading
                goHome();
                showContent();

            } catch (error) {
                console.error('Failed to load initial data:', error);
                showError(`Failed to load data. Please check the network connection and Budibase API/CORS settings. Details: ${error.message}`);
            }
        }

        // --- UI State Management ---

        function showLoading() {
            loadingContainer.style.display = 'flex';
            errorContainer.style.display = 'none';
            navigationGrid.style.display = 'none';
             updateTheme(); // Apply default theme during initial load
        }

        function showError(message) {
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'block';
            navigationGrid.style.display = 'none';
            errorMessage.textContent = message;
             updateTheme(); // Apply default theme on error
        }

        function showContent() {
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            navigationGrid.style.display = 'grid'; // Use grid display
        }

        // --- Theming ---
        function updateTheme(school = null) {
             const root = document.documentElement;
             if (school && school.primary_color && school.secondary_color) {
                 appState.currentTheme.primary = school.primary_color;
                 appState.currentTheme.secondary = school.secondary_color;
                 appState.currentTheme.accent = school.accent_color || '#757575'; // Use default if accent missing
             } else {
                 // Reset to defaults if no school selected (Home view)
                 appState.currentTheme.primary = '#000080';
                 appState.currentTheme.secondary = '#FFD700';
                 appState.currentTheme.accent = '#757575';
             }

             root.style.setProperty('--navy', appState.currentTheme.primary);
             root.style.setProperty('--gold', appState.currentTheme.secondary);
             // Optionally update other elements directly if CSS variables aren't sufficient
             pageHeader.style.backgroundColor = appState.currentTheme.primary;
             pageLogo.style.color = appState.currentTheme.secondary;
             pageFooter.style.backgroundColor = appState.currentTheme.primary;
             loadingSpinner.style.borderTopColor = appState.currentTheme.primary;

             // Update breadcrumb link colors
              const breadcrumbLinks = breadcrumbContainer.querySelectorAll('a');
              breadcrumbLinks.forEach(link => link.style.color = appState.currentTheme.primary);
              const breadcrumbSpans = breadcrumbContainer.querySelectorAll('.sep');
              breadcrumbSpans.forEach(span => span.style.color = appState.currentTheme.primary);
        }


        // --- Rendering Views ---

        // Render the correct view based on state
        function renderCurrentView() {
            navigationGrid.innerHTML = ''; // Clear previous content

             if (appState.navigationHistory.length === 0) {
                 // Home / Schools view
                 appState.currentSchool = null;
                 appState.currentSport = null;
                 renderSchoolsView();
                 updateTheme(); // Reset theme to default
            } else {
                 const lastNavItem = appState.navigationHistory[appState.navigationHistory.length - 1];
                 if (lastNavItem.type === 'school') {
                     // School selected -> show Sports view
                     appState.currentSchool = appState.schools.find(s => s.name === lastNavItem.name);
                     appState.currentSport = null;
                     if (appState.currentSchool) {
                         renderSportsView(appState.currentSchool);
                         updateTheme(appState.currentSchool);
                     } else {
                          showError(`School "${lastNavItem.name}" not found.`);
                          goHome(); // Go back home if school is invalid
                     }
                 } else if (lastNavItem.type === 'sport') {
                     // Sport selected -> show Teams view
                      appState.currentSport = lastNavItem.name;
                     if (appState.currentSchool) {
                         renderTeamsView(appState.currentSchool, appState.currentSport);
                         updateTheme(appState.currentSchool); // Keep school theme
                     } else {
                          showError(`Cannot show sport "${lastNavItem.name}" without a selected school.`);
                          goHome(); // Go back home
                     }
                 }
            }
            updateBreadcrumb();
            showContent(); // Ensure content area is visible
        }

        // Render Schools (Home View)
        function renderSchoolsView() {
            appState.schools.forEach(school => {
                const card = createNavigationCard(
                    school.name,
                    'School',
                    () => navigateTo('school', school.name),
                    school.media_url, // Use school image
                    school.primary_color,
                    school.secondary_color
                );
                navigationGrid.appendChild(card);
            });
        }

        // Render Sports for a selected School
        function renderSportsView(school) {
             // Find teams only for this school
            const schoolTeams = appState.teams.filter(team => team.school_name === school.name);
            // Get unique sports from these teams
            const uniqueSports = [...new Set(schoolTeams.map(team => team.sport_name))].sort();

            uniqueSports.forEach(sportName => {
                 // Try find a media url from one of the teams for this sport
                 const teamForMedia = schoolTeams.find(team => team.sport_name === sportName && team.media_url);
                 const mediaUrl = teamForMedia ? teamForMedia.media_url : school.media_url; // Fallback to school media

                const card = createNavigationCard(
                    sportName,
                    'Sport',
                    () => navigateTo('sport', sportName),
                    mediaUrl,
                    school.primary_color,
                    school.secondary_color
                );
                navigationGrid.appendChild(card);
            });

             // Find D1 and Pro athletes for this school
             const d1Athletes = appState.individuals.filter(i => i.school_name === school.name && i.type === 'd1_athlete');
             const proAthletes = appState.individuals.filter(i => i.school_name === school.name && i.type === 'pro_athlete');

             // Add D1 Athletes card
             if (d1Athletes.length > 0) {
                 const d1Media = d1Athletes[0]?.media_url || school.media_url;
                 const card = createNavigationCard(
                     'D1 Athletes',
                     `${d1Athletes.length} Athlete(s)`,
                     () => showAthletesList(d1Athletes, 'D1 Athletes', school),
                     d1Media,
                     school.primary_color,
                     school.secondary_color
                 );
                 navigationGrid.appendChild(card);
             }

             // Add Pro Athletes card
             if (proAthletes.length > 0) {
                 const proMedia = proAthletes[0]?.media_url || school.media_url;
                 const card = createNavigationCard(
                     'Pro Athletes',
                     `${proAthletes.length} Athlete(s)`,
                     () => showAthletesList(proAthletes, 'Professional Athletes', school),
                     proMedia,
                     school.primary_color,
                     school.secondary_color
                 );
                 navigationGrid.appendChild(card);
             }
        }

        // Render Teams for a selected School and Sport
        function renderTeamsView(school, sportName) {
             const teams = appState.teams.filter(
                 team => team.school_name === school.name && team.sport_name === sportName
             ).sort((a, b) => b.year.localeCompare(a.year)); // Sort newest first

             if (teams.length === 0) {
                 navigationGrid.innerHTML = `<p>No teams found for ${school.name} ${sportName}.</p>`;
                 return;
             }

             teams.forEach(team => {
                 const card = createNavigationCard(
                     team.year,
                     team.achievement || 'Team Record', // Add fallback text
                     () => showTeamDetail(team, school),
                     team.media_url || team.team_photo_url || school.media_url, // Use team media, fallback to photo or school
                     school.primary_color,
                     school.secondary_color
                 );
                 navigationGrid.appendChild(card);
             });
        }

        // --- Card Creation ---
        function createNavigationCard(title, subtitle, onClick, backgroundImageUrl, primaryColor, secondaryColor) {
            const card = document.createElement('div');
            card.className = 'nav-card';
            card.onclick = onClick; // Use onclick for simplicity here

            const content = document.createElement('div');
            content.className = 'nav-card-content';

            // Apply background image or fallback gradient
             const effectivePrimary = primaryColor || appState.currentTheme.primary;
            if (backgroundImageUrl && backgroundImageUrl !== 'placeholder_url') {
                content.style.backgroundImage = `url('${backgroundImageUrl}')`;
            } else {
                // Fallback gradient using effective colors
                 content.style.background = `linear-gradient(135deg, ${effectivePrimary} 0%, rgba(0, 0, 0, 0.7) 100%)`;
            }

            const titleEl = document.createElement('h2');
            titleEl.textContent = title;
            titleEl.style.color = secondaryColor || appState.currentTheme.secondary; // Dynamic color

            const subtitleEl = document.createElement('p');
            subtitleEl.textContent = subtitle;

            content.appendChild(titleEl);
            content.appendChild(subtitleEl);
            card.appendChild(content);

            return card;
        }


        // --- Modal Views ---

        // Show Team Details
        function showTeamDetail(team, school) {
             // Find players for this specific team (school, sport, year)
             const roster = appState.individuals.filter(
                 i => i.school_name === team.school_name &&
                      i.team_sport === team.sport_name &&
                      i.team_year === team.year &&
                      i.type === 'player'
             ).sort((a,b) => (a.name || '').localeCompare(b.name || '')); // Sort by name

            modalBody.innerHTML = `
                <div style="color: ${school.primary_color};">
                    <h2 style="margin-bottom: 0.25rem;">${team.school_name} ${team.sport_name} - ${team.year}</h2>
                    <h3 style="color: ${school.secondary_color}; margin-bottom: 1.5rem;">${team.achievement}</h3>

                    ${team.trophy_model_url ? `
                        <div class="trophy-display">
                            <div id="trophy-container-modal" class="trophy-container"></div>
                            <div class="trophy-controls">
                                <button class="trophy-control-btn" id="trophyResetBtn" aria-label="Reset trophy view">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        ` : '<p><em>No 3D trophy model available for this team.</em></p>'}

                    ${team.team_photo_url && team.team_photo_url !== 'placeholder_url' ? `
                        <img src="${team.team_photo_url}" alt="${team.school_name} ${team.sport_name} ${team.year} Team Photo" class="team-photo">
                    ` : ''}

                    <h3 style="margin-top: 2rem; color: ${school.primary_color};">Team Roster</h3>
                    ${roster.length > 0 ? `
                        <div class="team-grid">
                            ${roster.map(player => `
                                <div class="player-card"
                                     onclick="showPlayerStats('${player._id}', '${school._id}')"
                                     style="border-color: ${school.primary_color};"
                                     onmouseover="this.style.backgroundColor='${school.secondary_color}'; this.style.color='${school.primary_color}';"
                                     onmouseout="this.style.backgroundColor='var(--white)'; this.style.color='var(--dark-gray)';">

                                    ${player.media_url && player.media_url !== 'placeholder_url' ? `
                                         <img src="${player.media_url}" alt="${player.name}" class="player-photo" style="border-color: ${school.primary_color};">
                                    ` : `
                                        <div class="player-photo" style="border-color: ${school.primary_color}; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: ${school.accent_color};">
                                            <i class="fas fa-user"></i> <!-- Placeholder icon -->
                                        </div>
                                    `}
                                    <h4>${player.name}</h4>
                                    ${player.number ? `<p>#${player.number}` : ''} ${player.position ? `- ${player.position}</p>` : '</p>'}
                                </div>
                            `).join('')}
                        </div>
                        ` : '<p>No player roster information available.</p>'}
                </div>
            `;

            openModal();

             // Initialize trophy viewer AFTER modal is open and div exists
             if (team.trophy_model_url) {
                 // Ensure previous viewer is disposed if exists
                  if (appState.viewerInstance) {
                       // Add cleanup logic if necessary (e.g., remove listeners, dispose geometry/materials)
                       appState.viewerInstance = null;
                  }
                  // Use setTimeout to ensure the DOM is fully ready
                 setTimeout(() => {
                     const container = document.getElementById('trophy-container-modal');
                     if (container) {
                          appState.viewerInstance = new TrophyViewer('trophy-container-modal');
                          appState.viewerInstance.loadModel(team.trophy_model_url);

                          // Set button colors and add click listener
                          const resetButton = document.getElementById('trophyResetBtn');
                          if (resetButton) {
                               resetButton.style.backgroundColor = school.primary_color;
                               resetButton.style.color = school.secondary_color;
                               resetButton.onclick = () => appState.viewerInstance?.controls.reset();
                               resetButton.addEventListener('mouseover', () => {
                                    resetButton.style.backgroundColor = school.secondary_color;
                                    resetButton.style.color = school.primary_color;
                               });
                               resetButton.addEventListener('mouseout', () => {
                                    resetButton.style.backgroundColor = school.primary_color;
                                    resetButton.style.color = school.secondary_color;
                               });
                          }
                     } else {
                         console.error("Trophy container div not found in modal.");
                     }
                 }, 50); // 50ms delay
             }
        }


        // Show Player Statistics
        function showPlayerStats(playerId, schoolId) {
             const player = appState.individuals.find(p => String(p._id) === String(playerId)); // Ensure type match
             const school = appState.schools.find(s => String(s._id) === String(schoolId));

             if (!player || !school) {
                 modalBody.innerHTML = '<p>Error: Player or school data not found.</p>';
                 openModal();
                 return;
             }

             // Collect available stats - handle potentially missing fields gracefully
             const stats = [];
             const statFields = {
                 points_per_game: 'Points/Game', assists: 'Assists', rebounds: 'Rebounds',
                 passing_yards: 'Passing Yards', touchdowns: 'Touchdowns', completion_percentage: 'Completion %'
             };

             for (const [key, label] of Object.entries(statFields)) {
                 if (player[key] !== null && player[key] !== undefined && player[key] !== '') {
                     stats.push({ name: label, value: player[key] });
                 }
             }
              // Handle custom stat
             if (player.other_stat_name && player.other_stat_value) {
                 stats.push({ name: player.other_stat_name, value: player.other_stat_value });
             }

             modalBody.innerHTML = `
                <div style="color: ${school.primary_color};">
                     <div class="centered-container">
                         ${player.media_url && player.media_url !== 'placeholder_url' ? `
                             <img src="${player.media_url}" alt="${player.name}" class="player-photo" style="width: 150px; height: 150px; border-color: ${school.primary_color};">
                         ` : `
                             <div class="player-photo" style="width: 150px; height: 150px; border-color: ${school.primary_color}; display: flex; align-items: center; justify-content: center; font-size: 4rem; color: ${school.accent_color};">
                                 <i class="fas fa-user"></i>
                             </div>
                         `}
                         <h2 style="margin-top: 0.5rem;">${player.name}</h2>
                         <h3 style="color: ${school.secondary_color}; margin-bottom: 0.5rem;">
                             ${player.number ? `#${player.number}` : ''} ${player.position ? `- ${player.position}` : ''}
                         </h3>
                         <p>${player.school_name} ${player.team_sport} (${player.team_year})</p>
                     </div>

                     ${stats.length > 0 ? `
                         <div style="margin-top: 2rem;">
                             <h4 style="color: ${school.primary_color};">Statistics (${player.team_year})</h4>
                             <div class="stats-container">
                                 ${stats.map(stat => `
                                     <div class="stat-card" style="border: 1px solid ${school.accent_color};">
                                         <div class="stat-label">${stat.name}</div>
                                         <div class="stat-value" style="color: ${school.primary_color};">${stat.value}</div>
                                     </div>
                                 `).join('')}
                             </div>
                         </div>
                     ` : '<p style="margin-top: 2rem; text-align: center;"><em>No statistics available for this player/season.</em></p>'}
                 </div>
             `;
             openModal();
        }


        // Show D1 / Pro Athletes List
        function showAthletesList(athletes, title, school) {
             if (!athletes || athletes.length === 0) return;

             // Group athletes by sport
             const athletesBySport = {};
             athletes.forEach(athlete => {
                 const sport = athlete.sport || 'Unknown Sport'; // Group under Unknown if missing
                 if (!athletesBySport[sport]) athletesBySport[sport] = [];
                 athletesBySport[sport].push(athlete);
             });
             // Sort sports alphabetically
            const sortedSports = Object.keys(athletesBySport).sort();


             modalBody.innerHTML = `
                <h2 style="color: ${school.primary_color};">${school.name} - ${title}</h2>

                ${sortedSports.map(sport => `
                    <div class="athlete-category">
                        <h3 style="color: ${school.primary_color}; border-bottom-color: ${school.secondary_color};">${sport}</h3>
                        <div class="team-grid">
                            ${athletesBySport[sport].sort((a,b) => (a.name || '').localeCompare(b.name || '')).map(athlete => `
                                <div class="player-card" style="border-color: ${school.primary_color}; cursor: default;"
                                    onmouseover="this.style.backgroundColor='${school.secondary_color}'; this.style.color='${school.primary_color}';"
                                     onmouseout="this.style.backgroundColor='var(--white)'; this.style.color='var(--dark-gray)';">

                                     ${athlete.media_url && athlete.media_url !== 'placeholder_url' ? `
                                         <img src="${athlete.media_url}" alt="${athlete.name}" class="player-photo" style="border-color: ${school.primary_color};">
                                     ` : `
                                        <div class="player-photo" style="border-color: ${school.primary_color}; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: ${school.accent_color};">
                                             <i class="fas fa-user-graduate"></i>
                                        </div>
                                     `}
                                    <h4>${athlete.name}</h4>
                                     ${athlete.graduation_year ? `<p>Class of ${athlete.graduation_year}</p>`: ''}
                                     ${athlete.college ? `<p>College: ${athlete.college}</p>` : ''}
                                     ${athlete.professional_team ? `<p>Pro: ${athlete.professional_team}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
            openModal();
        }

        // --- Modal Handling ---
        function openModal() {
            detailModal.style.display = 'block';
            // Optional: Trap focus within the modal for accessibility
        }

        function closeModal() {
             detailModal.style.display = 'none';
             modalBody.innerHTML = ''; // Clear content
              // Dispose Three.js viewer if it exists
              if (appState.viewerInstance) {
                   // Add proper cleanup if TrophyViewer class implements it
                   appState.viewerInstance = null;
              }
        }

         // Close modal listeners
         detailModal.querySelector('.close-modal').addEventListener('click', closeModal);
         window.addEventListener('click', (e) => {
             if (e.target === detailModal) {
                 closeModal();
             }
         });
         window.addEventListener('keydown', (e) => {
             if (e.key === 'Escape' && detailModal.style.display === 'block') {
                 closeModal();
             }
         });


        // --- Navigation ---

        // Update breadcrumb display
        function updateBreadcrumb() {
            let breadcrumbHTML = `<a onclick="goHome()" title="Go to Home">Home</a>`;
            appState.navigationHistory.forEach((item, index) => {
                breadcrumbHTML += ` <span class="sep" style="color: ${appState.currentTheme.primary};">/</span> `;
                 if (index === appState.navigationHistory.length - 1) {
                    // Last item is not clickable
                    breadcrumbHTML += `<span>${item.name}</span>`;
                } else {
                     breadcrumbHTML += `<a onclick="goToPoint(${index})" title="Go back to ${item.name}">${item.name}</a>`;
                }
            });
            breadcrumbContainer.innerHTML = breadcrumbHTML;
             // Ensure link colors are updated after regenerating HTML
            const breadcrumbLinks = breadcrumbContainer.querySelectorAll('a');
            breadcrumbLinks.forEach(link => link.style.color = appState.currentTheme.primary);
        }

         // Navigate to a new level (school or sport)
        function navigateTo(type, name) {
            appState.navigationHistory.push({ type, name });
            renderCurrentView();
        }

        // Go back to the Home/Schools view
        function goHome() {
            appState.navigationHistory = [];
            renderCurrentView();
        }

        // Go back to a specific point in the history (clicked breadcrumb)
        function goToPoint(index) {
            appState.navigationHistory = appState.navigationHistory.slice(0, index + 1);
            renderCurrentView();
        }


        // --- Trophy Viewer Class (minor adjustments) ---
        class TrophyViewer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                     console.error(`Trophy container #${containerId} not found.`);
                     return; // Exit if container doesn't exist
                }
                // Clear container before setup
                this.container.innerHTML = '';
                this.setupLoadingState(); // Add loading state first

                // Basic WebGL check
                if (!window.WebGLRenderingContext) {
                     this.showError('WebGL is not supported or disabled in your browser.');
                     return;
                }

                 try {
                    this.renderer = new THREE.WebGLRenderer({
                        antialias: true,
                        alpha: true, // Allows transparent background if needed
                        powerPreference: "high-performance"
                    });
                    this.renderer.physicallyCorrectLights = true; // Use physically correct lighting model
                    this.renderer.outputEncoding = THREE.sRGBEncoding; // Correct color space
                    this.renderer.shadowMap.enabled = true;
                    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows
                     // Set size immediately
                     this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                     this.renderer.setPixelRatio(window.devicePixelRatio);
                     this.container.appendChild(this.renderer.domElement); // Add canvas to DOM
                 } catch (e) {
                     this.showError('Could not initialize WebGL Renderer.', e.message);
                     return;
                 }

                this.scene = new THREE.Scene();
                // Use a light background matching the page
                this.scene.background = new THREE.Color(0xf8f9fa); // var(--light-gray)

                this.camera = new THREE.PerspectiveCamera(45, this.container.clientWidth / this.container.clientHeight, 0.1, 100); // Adjust far plane if needed

                this.camera.position.set(0, 1.5, 6); // Adjusted initial camera position

                this.setupLighting();
                this.setupControls(); // Setup controls after camera/renderer

                // Handle resize
                this.resizeObserver = new ResizeObserver(() => this.onWindowResize());
                this.resizeObserver.observe(this.container);


                this.animate(); // Start animation loop
            }

             setupLoadingState() {
                this.loadingElement = document.createElement('div');
                this.loadingElement.className = 'trophy-loading'; // Use new styles
                this.loadingElement.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>Loading trophy model...</p>
                `;
                this.container.appendChild(this.loadingElement);
            }

             showError(message, details = '') {
                 console.error('Trophy Viewer Error:', message, details);
                 // Clear container before showing error
                 this.container.innerHTML = '';

                const errorElement = document.createElement('div');
                errorElement.className = 'trophy-error'; // Use new styles
                errorElement.innerHTML = `
                    <h3><i class="fas fa-exclamation-triangle"></i> Error Loading Trophy</h3>
                    <p>${message}</p>
                    ${details ? `<small>Details: ${details}</small>` : ''}
                    <p style="margin-top: 1rem;">Cannot display 3D model.</p>
                `;
                this.container.appendChild(errorElement);
                // No fallback trophy generation to keep it simple
             }

            setupLighting() {
                // Soft ambient light
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.6));

                // Key light
                const keyLight = new THREE.DirectionalLight(0xffffff, 0.8);
                keyLight.position.set(5, 5, 5);
                keyLight.castShadow = true;
                keyLight.shadow.mapSize.width = 1024; // Adjust shadow map resolution
                keyLight.shadow.mapSize.height = 1024;
                this.scene.add(keyLight);

                // Fill light from opposite side
                 const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
                 fillLight.position.set(-5, 2, -3);
                 this.scene.add(fillLight);

                 // Rim light from behind
                 const rimLight = new THREE.DirectionalLight(0xffffff, 0.3);
                 rimLight.position.set(0, 3, -5);
                 this.scene.add(rimLight);

                  // Optional: Ground plane for shadows
                  const groundGeometry = new THREE.PlaneGeometry(20, 20);
                  const groundMaterial = new THREE.ShadowMaterial({ opacity: 0.3 }); // Material to receive shadows
                  const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                  ground.rotation.x = -Math.PI / 2;
                  ground.position.y = -1.5; // Adjust based on model centering
                  ground.receiveShadow = true;
                  this.scene.add(ground);
            }


             setupControls() {
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.screenSpacePanning = false; // Keep panning intuitive
                this.controls.minDistance = 2;
                this.controls.maxDistance = 15;
                this.controls.maxPolarAngle = Math.PI / 1.8; // Prevent looking from below ground
                this.controls.target.set(0, 0.5, 0); // Aim slightly above origin, adjust based on model
                this.controls.update(); // Initial update
             }

            loadModel(url) {
                 if (!url || typeof url !== 'string') {
                    this.showError('Invalid or missing model URL.');
                    return;
                 }

                this.loadingElement.style.display = 'flex'; // Show loading state

                 // Remove previous model if exists
                 if (this.currentModel) {
                     this.scene.remove(this.currentModel);
                     // Add disposal of geometry/materials if needed
                 }
                  // Remove error message if exists
                 const errorMsg = this.container.querySelector('.trophy-error');
                 if (errorMsg) errorMsg.remove();


                const loader = new THREE.GLTFLoader();
                loader.load(
                    url,
                    (gltf) => {
                        this.loadingElement.style.display = 'none';

                        this.currentModel = gltf.scene;

                        // Enable shadows for all meshes in the model
                         this.currentModel.traverse((node) => {
                            if (node.isMesh) {
                                node.castShadow = true;
                                node.receiveShadow = true; // Meshes can receive shadows too
                            }
                        });

                        // Auto-center and scale model
                        const box = new THREE.Box3().setFromObject(this.currentModel);
                        const size = box.getSize(new THREE.Vector3());
                        const center = box.getCenter(new THREE.Vector3());

                        // Calculate scale factor to fit within a desired size (e.g., 3 units high)
                         const desiredHeight = 3.0;
                        const scale = desiredHeight / size.y;
                        this.currentModel.scale.set(scale, scale, scale);

                        // Adjust position to center it and place base near y=0
                        this.currentModel.position.x = -center.x * scale;
                        this.currentModel.position.y = -box.min.y * scale; // Align bottom of bounding box with y=0
                        this.currentModel.position.z = -center.z * scale;


                        this.scene.add(this.currentModel);

                        // Adjust controls target to the model's new center (approx)
                        this.controls.target.set(0, desiredHeight / 2, 0);
                        this.controls.update();
                    },
                    (xhr) => { // Progress
                        if (xhr.lengthComputable) {
                            const percent = Math.round((xhr.loaded / xhr.total) * 100);
                             this.loadingElement.querySelector('p').textContent = `Loading trophy model... ${percent}%`;
                        } else {
                             this.loadingElement.querySelector('p').textContent = `Loading trophy model...`;
                        }
                    },
                    (error) => { // Error
                         this.loadingElement.style.display = 'none';
                         console.error('Error loading GLTF model:', error);
                         // Provide more context in the error message
                         this.showError('Failed to load 3D trophy model.', `URL: ${url}, Error: ${error.message || 'Unknown loading error'}`);
                    }
                );
            }

            onWindowResize() {
                 // Check if container still exists and has dimensions
                 if (!this.container || this.container.clientWidth === 0 || this.container.clientHeight === 0) {
                     return;
                 }

                 this.camera.aspect = this.container.clientWidth / this.container.clientHeight;
                 this.camera.updateProjectionMatrix();
                 this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
            }

            animate() {
                // Ensure loop doesn't run if renderer is gone (e.g., during cleanup)
                if (!this.renderer) return;

                requestAnimationFrame(() => this.animate());
                if (this.controls) this.controls.update(); // Update controls if they exist
                this.renderer.render(this.scene, this.camera);
            }

             // Optional: Cleanup method when the viewer is no longer needed
             dispose() {
                 if (this.resizeObserver && this.container) {
                    this.resizeObserver.unobserve(this.container);
                 }
                 this.resizeObserver = null;

                 // Remove model and dispose resources
                 if (this.currentModel) {
                     this.scene.remove(this.currentModel);
                     // TODO: traverse and dispose geometry/material if needed
                 }
                 this.currentModel = null;

                 if (this.renderer) {
                     this.renderer.dispose();
                      if (this.renderer.domElement.parentElement) {
                          this.renderer.domElement.parentElement.removeChild(this.renderer.domElement);
                      }
                 }
                 this.renderer = null;
                 this.scene = null;
                 this.camera = null;
                 this.controls = null;
                 if (this.container) this.container.innerHTML = ''; // Clear container
                 this.container = null;
                  console.log("TrophyViewer disposed.");
             }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', loadAllData);

         // Expose functions needed by inline 'onclick' handlers
         window.goHome = goHome;
         window.goToPoint = goToPoint;
         window.showPlayerStats = showPlayerStats; // Make sure it's globally accessible
         window.loadAllData = loadAllData; // Expose retry button function

    </script>
</body>
</html>